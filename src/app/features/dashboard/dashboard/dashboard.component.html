<app-navbar></app-navbar>

<div class="h-[calc(100vh-55px)] px-4 md:px-5 py-3 md:py-3 flex justify-center overflow-hidden"
  style="font-family: 'Poppins', sans-serif;">
  <div class="w-full max-w-8xl rounded-3xl border border-[#F77FBE]
         shadow-[0_0_0_4px_rgba(247,127,190,0.15)]
         bg-white/90 backdrop-blur-sm
         px-3 md:px-6 py-5 md:py-7
         h-full flex flex-col overflow-hidden">


    <div class="mb-5 md:mb-7 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

      <!-- Left text -->
      <div>
        <p class="text-xs md:text-sm font-medium mb-1" style="color:#432338;">
          Hello ðŸ‘‹
        </p>
        <h1 class="text-2xl md:text-3xl font-bold tracking-tight mb-2" style="color:#371A2D;">
          Customer Dashboard
        </h1>
        <p class="text-xs md:text-sm leading-relaxed max-w-xl" style="color:#432338;">
          Hereâ€™s an overview of your customers. Search, add, edit or delete customers
          to keep your engagement workspace up to date.
        </p>
      </div>

      <!-- Right single stat -->
      <div class="rounded-xl border border-[#F77FBE] bg-[#FFE1F7]/60
           px-5 py-3 flex flex-col items-start min-w-[140px]">
        <span class="text-[11px] font-medium" style="color:#432338;">
          Total customers
        </span>
        <span class="text-xl font-bold" style="color:#371A2D;">
          {{ filteredCustomers().length }}
        </span>
      </div>

    </div>

    <div class="flex flex-col md:flex-row gap-3 md:gap-4 mb-6 md:mb-7 items-stretch md:items-center">
      <div
        class="flex-1 flex items-stretch rounded-2xl border border-[#F77FBE] bg-[#FFE1F7]/40 shadow-[0_4px_12px_rgba(247,127,190,0.12)]">
        <div class="relative flex-1">
          <span class="absolute left-3 top-1/2 -translate-y-1/2">
            <svg class="h-4 w-4" style="color:#F77FBE;" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
          </span>
          <input [(ngModel)]="query" type="text" placeholder="Search customers by name, industry, or location..."
            class="w-full h-full rounded-l-2xl border-0 bg-transparent pl-9 pr-3 py-2.5 text-xs md:text-sm focus:outline-none focus:ring-0"
            style="color:#432338;" />
        </div>

        <button (click)="onSearch()" class="px-4 md:px-5 text-xs md:text-sm font-semibold rounded-r-2xl transition
                 bg-[#F77FBE] text-white shadow-[0_2px_8px_rgba(247,127,190,0.35)]
                 hover:bg-[#FF80BA] active:scale-[0.98]">
          Search
        </button>
      </div>

      <button (click)="openAddModal()" class="inline-flex items-center justify-center gap-2 px-4 md:px-5 py-2.5
               rounded-2xl text-xs md:text-sm font-semibold transition
               bg-[#F77FBE] text-white shadow-[0_2px_10px_rgba(247,127,190,0.35)]
               hover:bg-[#FF80BA] active:scale-[0.98]">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        New customer
      </button>
    </div>

    <div *ngIf="loading" class="text-center py-16 md:py-20">
      <div class="inline-block animate-spin rounded-full h-10 w-10 mb-4 border-4 border-[#FFE1F7] border-t-[#F77FBE]">
      </div>
      <h3 class="text-base md:text-lg font-semibold mb-1" style="color:#371A2D;">
        Loading customers
      </h3>
      <p class="text-xs md:text-sm" style="color:#432338;">
        Please wait while we fetch your customer dataâ€¦
      </p>
    </div>

    <div *ngIf="error && !loading"
      class="rounded-2xl px-4 py-3 mb-5 flex items-start gap-2 border border-[#F77FBE] bg-[#FFE1F7]/60">
      <svg class="h-5 w-5 mt-0.5 shrink-0" style="color:#F77FBE;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-xs md:text-sm" style="color:#432338;">{{ error }}</p>
    </div>
    <div class="flex-1 overflow-y-auto pr-1">

      <div *ngIf="!loading" class="grid gap-3 md:gap-4
             grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5">

        <div *ngFor="let c of filteredCustomers()" class="group bg-white rounded-lg border border-[#F77FBE]
         px-3.5 py-3 flex flex-col justify-between
         transition-shadow duration-200
         hover:shadow-[0_8px_24px_rgba(247,127,190,0.35)]
         hover:border-[#FF80BA]">
          <div class="flex items-start justify-between gap-2 mb-1.5">
            <h3 class="text-sm font-semibold truncate pr-1.5" style="color:#371A2D;">
              {{ c.name }}
            </h3>

            <div class="flex items-center gap-1.5 shrink-0">
              <!-- EDIT -->
              <button (click)="openEditModal(c); $event.stopPropagation()"
                class="rounded-full p-1.5 transition hover:bg-[#FFE1F7]/70" style="color:#9348D4;"
                title="Edit customer">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M15.232 5.232l3.536 3.536M9 11l6.232-6.232a2.5 2.5 0 113.536 3.536L12.536 14.536A2 2 0 0111.12 15H9v-4z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4 20h16" />
                </svg>
              </button>

              <!-- DELETE -->
              <button (click)="deleteCustomer(c.customer_id); $event.stopPropagation()" class="rounded-full p-1.5 transition
               hover:bg-red-50
               disabled:opacity-60 disabled:cursor-not-allowed" [disabled]="deletingId === c.customer_id"
                style="color:#E53935;" title="Delete customer">
                <ng-container *ngIf="deletingId === c.customer_id; else deleteIcon">
                  <svg class="h-4 w-4 animate-spin" fill="none" stroke="currentColor" stroke-width="2"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"></circle>
                    <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-linecap="round"></path>
                  </svg>
                </ng-container>

                <ng-template #deleteIcon>
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 7h12" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 7V5a1 1 0 011-1h4a1 1 0 011 1v2" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 11v6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14 11v6" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 7l1 13a2 2 0 002 2h8a2 2 0 002-2l1-13" />
                  </svg>
                </ng-template>
              </button>
            </div>
          </div>

          <p class="text-[11px] leading-snug mb-2" style="color:#432338;">
            {{ c.industry }} â€¢ {{ c.employees }} employees â€¢ {{ c.location }}
          </p>

          <div class="flex items-center justify-between pt-1">
            <button (click)="openViewModal(c)" class="inline-flex items-center rounded-full px-2 py-0.5 text-[10px] font-medium
             bg-[#FFE1F7] text-[#432338] hover:bg-[#F77FBE] hover:text-white transition">
              View details
            </button>

            <button (click)="goToSurveyDashboard(c.customer_id)" class="w-6 h-6 rounded-full flex items-center justify-center text-white text-[10px]
             bg-[#F77FBE] group-hover:bg-[#FF80BA] transition hover:scale-110"
             title="Go to survey dashboard">
              <svg class="h-3 w-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <line x1="5" y1="12" x2="19" y2="12"></line>
                <polyline points="13 6 19 12 13 18"></polyline>
              </svg>
            </button>
          </div>
        </div>


      </div>
    </div>
    <div *ngIf="!loading && !error && filteredCustomers().length === 0" class="text-center py-14">
      <div class="w-16 h-16 mx-auto rounded-full flex items-center justify-center mb-4
               bg-[#FFE1F7]">
        <svg class="w-8 h-8" style="color:#F77FBE;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
        </svg>
      </div>
      <h3 class="text-base md:text-lg font-semibold mb-1" style="color:#371A2D;">
        No customers found
      </h3>
      <p class="text-xs md:text-sm mb-4" style="color:#432338;">
        {{
        query
        ? 'Try a different search or clear your filters.'
        : 'Add your first customer to start tracking engagement.'
        }}
      </p>
      <button (click)="openAddModal()" class="inline-flex items-center justify-center gap-2 px-4 md:px-5 py-2.5
               rounded-2xl text-xs md:text-sm font-semibold transition
               bg-[#F77FBE] text-white shadow-[0_2px_10px_rgba(247,127,190,0.35)]
               hover:bg-[#FF80BA] active:scale-[0.98]">
        <svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Add customer
      </button>
    </div>
  </div>

  <div *ngIf="showModal" class="fixed inset-0 z-50 flex items-center justify-center px-4"
    style="background: rgba(0,0,0,0.45);">
    <div class="w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl bg-white
             border border-[#F77FBE]
             shadow-[0_12px_32px_rgba(55,26,45,0.25)]">
      <div class="sticky top-0 flex items-center justify-between px-5 py-4 rounded-t-2xl
               border-b border-[#FFE1F7] bg-white/95 backdrop-blur">
        <h2 class="text-base md:text-lg font-semibold" style="color:#371A2D;">
          {{ isEditing ? 'Edit customer' : 'Add new customer' }}
        </h2>
        <button (click)="closeModal()" [disabled]="modalLoading" class="rounded-full p-1.5 transition disabled:opacity-50
                 hover:bg-[#FFE1F7]/70" style="color:#432338;">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="px-5 py-5 space-y-4">
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Company name
          </label>
          <input [(ngModel)]="name" placeholder="Enter company name" required [disabled]="modalLoading" class="w-full rounded-lg border border-[#F77FBE] px-3 py-2.5
                   text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-[#F77FBE]/60
                   disabled:cursor-not-allowed" style="color:#432338; background:white;" />
        </div>

        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Industry
          </label>
          <input [(ngModel)]="industry" placeholder="Enter industry" required [disabled]="modalLoading" class="w-full rounded-lg border border-[#F77FBE] px-3 py-2.5
                   text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-[#F77FBE]/60
                   disabled:cursor-not-allowed" style="color:#432338; background:white;" />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
              Employees
            </label>
            <input [(ngModel)]="employees" type="number" placeholder="Number of employees" [disabled]="modalLoading"
              class="w-full rounded-lg border border-[#F77FBE] px-3 py-2.5
                     text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-[#F77FBE]/60
                     disabled:cursor-not-allowed" style="color:#432338; background:white;" />
          </div>
          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
              Location
            </label>
            <input [(ngModel)]="location" placeholder="City, country" [disabled]="modalLoading" class="w-full rounded-lg border border-[#F77FBE] px-3 py-2.5
                     text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-[#F77FBE]/60
                     disabled:cursor-not-allowed" style="color:#432338; background:white;" />
          </div>
        </div>

        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Overview
          </label>
          <textarea [(ngModel)]="overview" rows="3" placeholder="Customer overview or description"
            [disabled]="modalLoading" class="w-full rounded-2xl border border-[#F77FBE] px-3 py-2.5
                   text-xs md:text-sm focus:outline-none focus:ring-2 focus:ring-[#F77FBE]/60
                   disabled:cursor-not-allowed" style="color:#432338; background:white; resize: vertical;"></textarea>
        </div>

        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-2">
          <button (click)="closeModal()" [disabled]="modalLoading" class="order-2 sm:order-1 px-4 py-2.5 rounded-2xl text-xs md:text-sm
                   font-semibold border border-[#F77FBE]
                   bg-[#FFE1F7] text-[#432338]
                   hover:bg-[#FFB6B3] transition disabled:opacity-50 disabled:cursor-not-allowed">
            Cancel
          </button>

          <button (click)="submit()" [disabled]="modalLoading" class="order-1 sm:order-2 px-4 py-2.5 rounded-2xl text-xs md:text-sm
                   font-semibold text-white
                   bg-[#F77FBE] hover:bg-[#FF80BA]
                   shadow-[0_2px_10px_rgba(247,127,190,0.35)]
                   active:scale-[0.98]
                   flex items-center justify-center gap-2
                   disabled:opacity-60 disabled:cursor-not-allowed transition">
            <svg *ngIf="modalLoading" class="h-4 w-4 animate-spin" fill="none" stroke="currentColor" stroke-width="2"
              viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"></circle>
              <path class="opacity-75" d="M4 12a8 8 0 018-8" stroke-linecap="round"></path>
            </svg>
            <span>
              {{
              isEditing
              ? (modalLoading ? 'Updatingâ€¦' : 'Update customer')
              : (modalLoading ? 'Savingâ€¦' : 'Save customer')
              }}
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- VIEW MODAL -->
  <div *ngIf="showViewModal" class="fixed inset-0 z-50 flex items-center justify-center px-4"
    style="background: rgba(0,0,0,0.45);">
    <div class="w-full max-w-md max-h-[90vh] overflow-y-auto rounded-2xl bg-white
             border border-[#F77FBE]
             shadow-[0_12px_32px_rgba(55,26,45,0.25)]">
      <div class="sticky top-0 flex items-center justify-between px-5 py-4 rounded-t-2xl
               border-b border-[#FFE1F7] bg-white/95 backdrop-blur">
        <h2 class="text-base md:text-lg font-semibold" style="color:#371A2D;">
          Customer Details
        </h2>
        <button (click)="closeViewModal()" class="rounded-full p-1.5 transition
                 hover:bg-[#FFE1F7]/70" style="color:#432338;">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="px-5 py-5 space-y-4">
        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Company name
          </label>
          <p class="text-xs md:text-sm px-3 py-2.5 rounded-lg border border-[#F77FBE]/30 bg-[#FFE1F7]/20"
             style="color:#432338;">{{ viewingCustomer?.name }}</p>
        </div>

        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Industry
          </label>
          <p class="text-xs md:text-sm px-3 py-2.5 rounded-lg border border-[#F77FBE]/30 bg-[#FFE1F7]/20"
             style="color:#432338;">{{ viewingCustomer?.industry }}</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
              Employees
            </label>
            <p class="text-xs md:text-sm px-3 py-2.5 rounded-lg border border-[#F77FBE]/30 bg-[#FFE1F7]/20"
               style="color:#432338;">{{ viewingCustomer?.employees || 'N/A' }}</p>
          </div>
          <div>
            <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
              Location
            </label>
            <p class="text-xs md:text-sm px-3 py-2.5 rounded-lg border border-[#F77FBE]/30 bg-[#FFE1F7]/20"
               style="color:#432338;">{{ viewingCustomer?.location || 'N/A' }}</p>
          </div>
        </div>

        <div>
          <label class="block text-xs font-semibold mb-1.5" style="color:#371A2D;">
            Overview
          </label>
          <p class="text-xs md:text-sm px-3 py-2.5 rounded-lg border border-[#F77FBE]/30 bg-[#FFE1F7]/20 min-h-[80px]"
             style="color:#432338;">{{ viewingCustomer?.overview || 'No overview provided' }}</p>
        </div>

        <div class="flex flex-col sm:flex-row justify-end gap-3 pt-2">
          <button (click)="closeViewModal()" class="order-1 sm:order-2 px-4 py-2.5 rounded-2xl text-xs md:text-sm
                   font-semibold text-white
                   bg-[#F77FBE] hover:bg-[#FF80BA]
                   shadow-[0_2px_10px_rgba(247,127,190,0.35)]
                   active:scale-[0.98]
                   transition">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>